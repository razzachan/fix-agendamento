<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Verifica√ß√£o de Tabelas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .card {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { border-left: 4px solid #28a745; }
        .error { border-left: 4px solid #dc3545; }
        .warning { border-left: 4px solid #ffc107; }
        .info { border-left: 4px solid #17a2b8; }
        h1 { color: #333; text-align: center; }
        h2 { color: #007bff; }
        .step {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }
        .code {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 14px;
            margin: 10px 0;
            overflow-x: auto;
        }
        .command {
            background: #343a40;
            color: #fff;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
        }
        .result {
            background: #d1ecf1;
            color: #0c5460;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .checklist {
            list-style: none;
            padding: 0;
        }
        .checklist li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .checklist li:before {
            content: "‚òê ";
            color: #007bff;
            font-weight: bold;
            margin-right: 8px;
        }
        .checklist li.done:before {
            content: "‚úÖ ";
            color: #28a745;
        }
        .priority-high { border-left: 4px solid #dc3545; }
        .priority-medium { border-left: 4px solid #ffc107; }
        .priority-low { border-left: 4px solid #28a745; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üîç Verifica√ß√£o e Sincroniza√ß√£o de Tabelas</h1>
    
    <div class="card info">
        <h2>üéØ Objetivo</h2>
        <p>Verificar e corrigir inconsist√™ncias entre as tabelas <code>service_orders</code> e <code>scheduled_services</code>.</p>
        
        <h3>Problemas a Resolver:</h3>
        <ul>
            <li>üì¶ <strong>OS √≥rf√£s</strong>: Ordens com agendamento mas sem registro em scheduled_services</li>
            <li>üëª <strong>Agendamentos √≥rf√£os</strong>: Agendamentos sem OS vinculada</li>
            <li>‚ö†Ô∏è <strong>Dados inconsistentes</strong>: Informa√ß√µes diferentes entre as tabelas</li>
        </ul>
    </div>

    <div class="card warning">
        <h2>‚ö†Ô∏è IMPORTANTE - Leia Antes de Executar</h2>
        <div class="step">
            <h3>1. üõ°Ô∏è Fa√ßa Backup</h3>
            <div class="code">
-- Execute no SQL Editor do Supabase:
CREATE TABLE service_orders_backup AS SELECT * FROM service_orders;
CREATE TABLE scheduled_services_backup AS SELECT * FROM scheduled_services;
            </div>
        </div>

        <div class="step">
            <h3>2. üß™ Teste em Desenvolvimento</h3>
            <p>Execute primeiro em ambiente de teste antes de aplicar em produ√ß√£o.</p>
        </div>

        <div class="step">
            <h3>3. üîç Modo DRY RUN</h3>
            <p>Sempre execute primeiro em modo de an√°lise (DRY RUN) antes de aplicar corre√ß√µes.</p>
        </div>
    </div>

    <div class="card success">
        <h2>üìã Passo a Passo</h2>

        <div class="step priority-high">
            <h3>ETAPA 1: An√°lise SQL (Recomendado)</h3>
            <p><strong>Arquivo:</strong> <code>verificar-sincronizar-tabelas.sql</code></p>
            
            <ol>
                <li>Abra o <strong>SQL Editor</strong> do Supabase</li>
                <li>Copie e cole o conte√∫do do arquivo SQL</li>
                <li>Execute <strong>se√ß√£o por se√ß√£o</strong> para an√°lise</li>
                <li>Analise os resultados antes de prosseguir</li>
            </ol>

            <div class="result">
                <strong>Resultados esperados:</strong><br>
                ‚Ä¢ Estrutura das tabelas<br>
                ‚Ä¢ Contagem de registros<br>
                ‚Ä¢ Lista de OS √≥rf√£s<br>
                ‚Ä¢ Lista de agendamentos √≥rf√£os<br>
                ‚Ä¢ Verifica√ß√£o de duplica√ß√µes<br>
                ‚Ä¢ Inconsist√™ncias de dados
            </div>
        </div>

        <div class="step priority-medium">
            <h3>ETAPA 2: An√°lise Program√°tica (Opcional)</h3>
            <p><strong>Arquivo:</strong> <code>src/scripts/sincronizar-tabelas.ts</code></p>
            
            <div class="command">
# An√°lise (DRY RUN)
npx tsx src/scripts/sincronizar-tabelas.ts
            </div>

            <div class="result">
                <strong>Sa√≠da esperada:</strong><br>
                üìä AN√ÅLISE DAS TABELAS<br>
                üì¶ service_orders com agendamento: 45<br>
                üìÖ scheduled_services: 38<br>
                üîç OS √≥rf√£s: 7<br>
                üëª Agendamentos √≥rf√£os: 2
            </div>
        </div>

        <div class="step priority-high">
            <h3>ETAPA 3: Corre√ß√£o (Escolha UMA op√ß√£o)</h3>
            
            <h4>Op√ß√£o A: Corre√ß√£o Manual (SQL) - RECOMENDADO</h4>
            <ol>
                <li>No arquivo SQL, <strong>descomente</strong> os comandos de corre√ß√£o</li>
                <li>Execute <strong>um comando por vez</strong></li>
                <li>Verifique os resultados ap√≥s cada comando</li>
            </ol>

            <h4>Op√ß√£o B: Corre√ß√£o Autom√°tica (TypeScript)</h4>
            <div class="command">
# ATEN√á√ÉO: Far√° altera√ß√µes reais no banco!
npx tsx src/scripts/sincronizar-tabelas.ts --execute
            </div>
        </div>

        <div class="step priority-low">
            <h3>ETAPA 4: Verifica√ß√£o Final</h3>
            <ol>
                <li>Execute novamente a an√°lise</li>
                <li>Verifique se OS √≥rf√£s = 0</li>
                <li>Verifique se agendamentos √≥rf√£os = 0</li>
                <li>Teste o calend√°rio no sistema</li>
            </ol>
        </div>
    </div>

    <div class="card info">
        <h2>üîß Arquivos Criados</h2>
        
        <table>
            <tr>
                <th>Arquivo</th>
                <th>Tipo</th>
                <th>Descri√ß√£o</th>
                <th>Uso</th>
            </tr>
            <tr>
                <td>verificar-sincronizar-tabelas.sql</td>
                <td>SQL</td>
                <td>An√°lise completa + comandos de corre√ß√£o</td>
                <td>SQL Editor do Supabase</td>
            </tr>
            <tr>
                <td>src/scripts/sincronizar-tabelas.ts</td>
                <td>TypeScript</td>
                <td>Script program√°tico de sincroniza√ß√£o</td>
                <td>Terminal (npx tsx)</td>
            </tr>
            <tr>
                <td>guia-sincronizacao-tabelas.md</td>
                <td>Documenta√ß√£o</td>
                <td>Guia completo do processo</td>
                <td>Refer√™ncia</td>
            </tr>
        </table>
    </div>

    <div class="card warning">
        <h2>üîç Comandos de Verifica√ß√£o R√°pida</h2>
        
        <h3>Verificar Situa√ß√£o Atual:</h3>
        <div class="code">
-- Contar registros
SELECT 
    (SELECT COUNT(*) FROM service_orders WHERE scheduled_date IS NOT NULL) as os_agendadas,
    (SELECT COUNT(*) FROM scheduled_services) as agendamentos_total;

-- OS sem agendamento espec√≠fico
SELECT COUNT(*) as os_sem_agendamento
FROM service_orders so
LEFT JOIN scheduled_services ss ON ss.service_order_id = so.id
WHERE so.scheduled_date IS NOT NULL 
  AND so.technician_id IS NOT NULL
  AND ss.id IS NULL
  AND so.status NOT IN ('cancelled', 'completed');

-- Agendamentos √≥rf√£os
SELECT COUNT(*) as agendamentos_orfaos
FROM scheduled_services ss
LEFT JOIN service_orders so ON so.id = ss.service_order_id
WHERE ss.service_order_id IS NULL 
   OR so.id IS NULL 
   OR so.status IN ('cancelled', 'completed');
        </div>
    </div>

    <div class="card success">
        <h2>‚úÖ Checklist de Verifica√ß√£o</h2>
        
        <ul class="checklist">
            <li>Backup das tabelas criado</li>
            <li>An√°lise SQL executada</li>
            <li>Problemas identificados</li>
            <li>Corre√ß√µes aplicadas</li>
            <li>Verifica√ß√£o final realizada</li>
            <li>Calend√°rio testado</li>
            <li>Sistema funcionando corretamente</li>
        </ul>
    </div>

    <div class="card info">
        <h2>üìä Resultados Esperados</h2>
        
        <h3>Antes da Sincroniza√ß√£o:</h3>
        <div class="result">
            üì¶ service_orders com agendamento: 45<br>
            üìÖ scheduled_services: 38<br>
            üîç OS √≥rf√£s: 7<br>
            üëª Agendamentos √≥rf√£os: 2<br>
            ‚ö†Ô∏è Inconsist√™ncias: 3
        </div>

        <h3>Depois da Sincroniza√ß√£o:</h3>
        <div class="result">
            üì¶ service_orders com agendamento: 45<br>
            üìÖ scheduled_services: 45<br>
            üîç OS √≥rf√£s: 0<br>
            üëª Agendamentos √≥rf√£os: 0<br>
            ‚ö†Ô∏è Inconsist√™ncias: 0
        </div>
    </div>

    <div class="card success">
        <h2>üéØ Benef√≠cios da Sincroniza√ß√£o</h2>
        
        <ul>
            <li>‚úÖ <strong>Calend√°rio consistente</strong> - Todos os agendamentos aparecem</li>
            <li>‚úÖ <strong>Sem duplica√ß√£o</strong> - Eventos √∫nicos no calend√°rio</li>
            <li>‚úÖ <strong>Performance melhorada</strong> - Consultas mais eficientes</li>
            <li>‚úÖ <strong>Dados organizados</strong> - Relacionamentos corretos</li>
            <li>‚úÖ <strong>Sistema confi√°vel</strong> - Experi√™ncia do usu√°rio melhorada</li>
        </ul>
    </div>

    <script>
        console.log('üîç Guia de verifica√ß√£o de tabelas carregado');
        console.log('üìã Siga o passo a passo para sincronizar as tabelas');
        console.log('‚ö†Ô∏è Lembre-se: sempre fa√ßa backup antes de executar corre√ß√µes!');
        
        // Simular checklist interativo
        document.querySelectorAll('.checklist li').forEach((item, index) => {
            item.addEventListener('click', function() {
                this.classList.toggle('done');
                console.log(`${this.classList.contains('done') ? '‚úÖ' : '‚òê'} ${this.textContent}`);
            });
        });
    </script>
</body>
</html>
